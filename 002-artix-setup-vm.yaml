# SPICE Guest Setup
setup_spice_guest:
  packages:
    command: 'sudo pacman -S {package} --needed --noconfirm'
    package:
      - 'world/spice-vdagent'
      - 'world/spice-protocol'
      - 'world/xf86-video-qxl'
      - 'world/xorg-xrandr'
  enable_services:
    shell:
      - 'sudo ln -s /etc/runit/sv/spice-vdagentd /var/service/'  # Enable SPICE agent service
      - 'sudo sv start spice-vdagentd'  # Start SPICE agent service
  configure_xorg:
    file:
      create: true
      name: '/etc/X11/xorg.conf.d/10-qxl.conf'
      content: |
        Section "Device"
            Identifier "QXL"
            Driver "qxl"
        EndSection
  test_setup:
    shell:
      - 'ps aux | grep spice-vdagent > /var/log/spice-guest-setup.log'  # Verify SPICE agent is running
      - 'xrandr --query >> /var/log/spice-guest-setup.log'  # Log resolution details
  optional_audio:
    packages:
      command: 'sudo pacman -S {package} --needed --noconfirm'
      package:
        - 'world/alsa-utils'
        - 'world/pipewire'
        - 'world/pipewire-alsa'
        - 'world/pipewire-pulse'
    shell:
      - 'speaker-test -t wav -c 2 >> /var/log/spice-guest-setup.log 2>&1'  # Test audio setup
